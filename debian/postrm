#!/bin/sh
# postrm script for dbus-mqtt-bridge
# SPDX-License-Identifier: GPL-3.0-or-later
# Copyright (C) 2026 Ed Lee

set -e

case "$1" in
    purge)
        # Remove system user and group
        if getent passwd dbus-mqtt-bridge >/dev/null 2>&1; then
            deluser --system dbus-mqtt-bridge >/dev/null 2>&1 || true
        fi
        
        if getent group dbus-mqtt-bridge >/dev/null 2>&1; then
            delgroup --system dbus-mqtt-bridge >/dev/null 2>&1 || true
        fi
        
        # Remove configuration directory (ask user first via debconf if possible)
        # Note: dpkg handles conffiles automatically, but we created additional files
        if [ -d /etc/dbus-mqtt-bridge ]; then
            echo "Removing configuration directory /etc/dbus-mqtt-bridge"
            rm -rf /etc/dbus-mqtt-bridge
        fi
        
        # Remove D-Bus policy
        if [ -f /etc/dbus-1/system.d/dbus-mqtt-bridge.conf ]; then
            echo "Removing D-Bus policy /etc/dbus-1/system.d/dbus-mqtt-bridge.conf"
            rm -f /etc/dbus-1/system.d/dbus-mqtt-bridge.conf
            
            # Reload D-Bus configuration
            if [ -x /usr/bin/dbus-send ]; then
                dbus-send --system --type=method_call --dest=org.freedesktop.DBus \
                         / org.freedesktop.DBus.ReloadConfig >/dev/null 2>&1 || true
            fi
        fi
        
        # Remove log directory
        if [ -d /var/log/dbus-mqtt-bridge ]; then
            echo "Removing log directory /var/log/dbus-mqtt-bridge"
            rm -rf /var/log/dbus-mqtt-bridge
        fi
    ;;

    remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        # Don't remove user/config on upgrade or failed operations
    ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
<!DOCTYPE busconfig PUBLIC "-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd">
<!--
  D-Bus Policy for dbus-mqtt-bridge
  SPDX-License-Identifier: GPL-3.0-or-later
  Copyright (C) 2026 Ed Lee
  
  This file controls which D-Bus services the dbus-mqtt-bridge user can access.
  
  IMPORTANT: This is a TEMPLATE with EXAMPLES. You MUST customize this file
  to match the actual D-Bus services, interfaces, and methods defined in
  your /etc/dbus-mqtt-bridge/config.yaml file.
  
  After editing, reload D-Bus configuration:
    sudo systemctl reload dbus
  
  For more information:
    man dbus-daemon
    man dbus-mqtt-bridge
-->
<busconfig>
  <!-- Policy for dbus-mqtt-bridge user -->
  <policy user="dbus-mqtt-bridge">
    <!-- Allow connecting to the system bus -->
    <allow send_destination="org.freedesktop.DBus"/>
    <allow receive_sender="org.freedesktop.DBus"/>
    
    <!-- 
      ========================================================================
      CUSTOMIZE THE FOLLOWING BASED ON YOUR config.yaml
      ========================================================================
      
      For each dbus_to_mqtt mapping, you need a "receive" rule.
      For each mqtt_to_dbus mapping, you need a "send" rule.
    -->
    
    <!-- EXAMPLE 1: Receive NetworkManager signals (dbus_to_mqtt) -->
    <!--
    <allow send_destination="org.freedesktop.NetworkManager"
           send_interface="org.freedesktop.NetworkManager"
           send_type="method_call"
           send_member="GetDevices"/>
    <allow receive_sender="org.freedesktop.NetworkManager"
           receive_interface="org.freedesktop.NetworkManager"
           receive_type="signal"
           receive_member="StateChanged"/>
    <allow receive_sender="org.freedesktop.NetworkManager"
           receive_interface="org.freedesktop.NetworkManager.Device"
           receive_type="signal"/>
    -->
    
    <!-- EXAMPLE 2: Call systemd methods (mqtt_to_dbus) -->
    <!--
    <allow send_destination="org.freedesktop.systemd1"
           send_interface="org.freedesktop.systemd1.Manager"
           send_type="method_call"
           send_member="StartUnit"/>
    <allow send_destination="org.freedesktop.systemd1"
           send_interface="org.freedesktop.systemd1.Manager"
           send_type="method_call"
           send_member="StopUnit"/>
    <allow send_destination="org.freedesktop.systemd1"
           send_interface="org.freedesktop.systemd1.Manager"
           send_type="method_call"
           send_member="RestartUnit"/>
    <allow receive_sender="org.freedesktop.systemd1"
           receive_interface="org.freedesktop.systemd1.Manager"
           receive_type="signal"/>
    -->
    
    <!-- EXAMPLE 3: Custom D-Bus service -->
    <!--
    <allow send_destination="com.example.MyService"
           send_interface="com.example.MyInterface"
           send_type="method_call"
           send_member="MyMethod"/>
    <allow receive_sender="com.example.MyService"
           receive_interface="com.example.MyInterface"
           receive_type="signal"
           receive_member="MySignal"/>
    -->
    
    <!-- Common: Allow introspection and properties (often needed) -->
    <!--
    <allow send_interface="org.freedesktop.DBus.Introspectable"/>
    <allow send_interface="org.freedesktop.DBus.Properties"/>
    <allow receive_interface="org.freedesktop.DBus.Properties"/>
    -->
    
    <!-- 
      ========================================================================
      SECURITY: Deny-by-default
      ========================================================================
      
      Everything not explicitly allowed above is denied. This ensures that
      dbus-mqtt-bridge can ONLY access the specific D-Bus services you
      configure, limiting the impact if the bridge is compromised.
    -->
    
    <!-- Deny all other method calls and signals -->
    <deny send_type="method_call"/>
    <deny send_type="signal"/>
  </policy>
  
  <!--
    POLICY GUIDELINES:
    
    1. Minimal Permissions:
       Only allow the specific services, interfaces, and members needed.
       Avoid wildcards unless absolutely necessary.
    
    2. Match Your Config:
       For each mapping in config.yaml, add corresponding D-Bus policy rules:
       - dbus_to_mqtt mappings need "receive" rules
       - mqtt_to_dbus mappings need "send" rules
    
    3. Test Carefully:
       After changes, test that the bridge works:
         sudo systemctl restart dbus-mqtt-bridge
         sudo journalctl -u dbus-mqtt-bridge -f
       
       Look for "Access denied" errors which indicate missing permissions.
    
    4. Security Review:
       Consider what MQTT clients can do via this bridge. If MQTT is exposed
       to untrusted networks, carefully limit which D-Bus methods can be
       called and which signals are forwarded.
    
    5. Documentation:
       Document why each permission is needed, especially for future audits.
  -->
</busconfig>